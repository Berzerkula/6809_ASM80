0000                             ; OMEN PIA test
0000                             ; 6809 source (OMEN Kilo)
0000                             ; 
0000                             ; It just set some bits up and some down
0000                             ; 
0000                             ; PIA is connected IO3
0000                PIA:      EQU   $9000   
0000                             ; 
0000                             ;Common PIA addresses - using the highest possible
0000                PORTA:    EQU   PIA+$3fc   
0000                DDRA:     EQU   PORTA   
0000                CRA:      EQU   PIA+$3fd   
0000                PORTB:    EQU   PIA+$3fe   
0000                DDRB:     EQU   PORTB   
0000                CRB:      EQU   PIA+$3ff   
0000                             ; 
0200                          .ORG   $200   
0200                          .ENT   $   
0200                             ; 
0200   7E 02 03               JMP   flip   
0203                             ; 
0203                             ; Set bit pattern
0203                FLIP:        
0203   86 AA                  LDA   #$AA   
0205   B7 93 FC               STA   PORTA   
0208   B7 93 FE               STA   PORTB   
020B   BD 02 1F               JSR   qtrscd   
020E   7E 02 11               JMP   flop   
0211                             ; 
0211                FLOP:        
0211   86 55                  LDA   #$55   
0213   B7 93 FC               STA   PORTA   
0216   B7 93 FE               STA   PORTB   
0219   BD 02 1F               JSR   qtrscd   
021C   7E 02 03               JMP   flip   
021F                             ; 
021F   86 FA        QTRSCD:   LDA   #250   ; 250 MILLISECONDS (FA HEX)
0221   BD 02 28               JSR   DELAY   
0224   5A                     DECB      
0225   26 F8                  BNE   QTRSCD   ; CONTINUE UNTIL DONE
0227   39                     RTS      
0228                             ; 
0228                             ; Cycles Per Millisecond - User Supplied
0228                             ; 
0228                CPMS:     EQU   2000   ; 1000 = 1 MHz Clock
0228                             ; 2000 = 2 MHz Clock
0228                MFAC:     EQU   CPMS/20   ; Multiply factor for all
0228                             ; except last millisecond
0228                MFACM:    EQU   MFAC-4   ; Multiplying factor for last
0228                             ; millisecond
0228                DELAY:       
0228                             ; Do all but the last millisecond
0228                             ; 
0228   34 16                  PSHS   D,X   ; save registers to stack
022A   C6 64                  LDB   #MFAC   ; Get multiplying factor
022C   4A                     DECA      ; Reduce number of ms by 1
022D   3D                     MUL      ; Multiply factor times ms
022E   1F 02                  TFR   D,Y   ; Transfer loop count to X
0230   BD 02 3F               JSR   DLY   
0233                             ; Account for 80 ms overhead delay by reducing last ms's count
0233                             ; 
0233   8E 00 64               LDX   #MFAC   ; Get reduced count
0236   BD 02 3F               JSR   DLY   ; Delay last millisecond
0239   35 16                  PULS   D,X   ; Restore registers
023B   39                     RTS      
023C                             ; 
023C                             ; ROUTINE:          DLY
023C                             ; PURPOSE:          DELAY ROUTING
023C                             ; ENTRY:            REGISTER X = COUNT
023C                             ; EXIT:             REGISTER X = 0
023C                             ; REGISETERS USED:  X
023C   8E 00 64               LDX   #MFAC   
023F   20 00        DLY:      BRA   DLY1   
0241   20 00        DLY1:     BRA   DLY2   
0243   20 00        DLY2:     BRA   DLY3   
0245   20 00        DLY3:     BRA   DLY4   
0247   30 1F        DLY4:     LEAX   -1,X   
0249   26 F4                  BNE   DLY   
024B   39                     RTS      
024C                             ; 
024C                             ; and done
024C                DONE:        
024C   7E E0 00               JMP   $E000   


PIA:                9000 DEFINED AT LINE 7
                    > USED AT LINE 10
                    > USED AT LINE 12
                    > USED AT LINE 13
                    > USED AT LINE 15
PORTA:              93FC DEFINED AT LINE 10
                    > USED AT LINE 11
                    > USED AT LINE 25
                    > USED AT LINE 32
DDRA:               93FC DEFINED AT LINE 11
CRA:                93FD DEFINED AT LINE 12
PORTB:              93FE DEFINED AT LINE 13
                    > USED AT LINE 14
                    > USED AT LINE 26
                    > USED AT LINE 33
DDRB:               93FE DEFINED AT LINE 14
CRB:                93FF DEFINED AT LINE 15
FLIP:               0203 DEFINED AT LINE 23
                    > USED AT LINE 20
                    > USED AT LINE 35
FLOP:               0211 DEFINED AT LINE 30
                    > USED AT LINE 28
QTRSCD:             021F DEFINED AT LINE 37
                    > USED AT LINE 27
                    > USED AT LINE 34
                    > USED AT LINE 40
CPMS:               07D0 DEFINED AT LINE 3 IN delay.a09
                    > USED AT LINE 6 IN delay.a09
MFAC:               0064 DEFINED AT LINE 6 IN delay.a09
                    > USED AT LINE 9 IN delay.a09
MFACM:              0060 DEFINED AT LINE 9 IN delay.a09
DELAY:              0228 DEFINED AT LINE 12 IN delay.a09
                    > USED AT LINE 38
DLY:                023F DEFINED AT LINE 36 IN delay.a09
                    > USED AT LINE 21 IN delay.a09
                    > USED AT LINE 26 IN delay.a09
                    > USED AT LINE 41 IN delay.a09
DLY1:               0241 DEFINED AT LINE 37 IN delay.a09
                    > USED AT LINE 36 IN delay.a09
DLY2:               0243 DEFINED AT LINE 38 IN delay.a09
                    > USED AT LINE 37 IN delay.a09
DLY3:               0245 DEFINED AT LINE 39 IN delay.a09
                    > USED AT LINE 38 IN delay.a09
DLY4:               0247 DEFINED AT LINE 40 IN delay.a09
                    > USED AT LINE 39 IN delay.a09
DONE:               024C DEFINED AT LINE 46
